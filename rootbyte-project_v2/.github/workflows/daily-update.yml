name: Daily Content Update

on:
  schedule:
    # 6:00 AM Philippine Time = 22:00 UTC previous day
    - cron: '0 22 * * *'
  workflow_dispatch: # allow manual trigger

permissions:
  contents: write

jobs:
  daily-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci --if-present

      - name: Fetch trending tech news
        env:
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SITE_URL: https://rootbyte.com
        run: node scripts/fetch-trending.js

      - name: Run build (regenerate sitemap, categories.json)
        run: node scripts/build.js

      - name: Commit and push content updates
        run: |
          git config --local user.email "bot@rootbyte.com"
          git config --local user.name "RootByte Bot"
          git add src/content/daily-update.json src/content/categories.json src/sitemap.xml src/content/did-you-know.json
          git diff --staged --quiet || git commit -m "ðŸ¤– Daily content update $(date '+%Y-%m-%d %H:%M PHT')"
          git push
